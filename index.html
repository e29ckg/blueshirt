<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FullCalendar CSS and JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>

    <title>BlueShirt</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
        font-size: 14px;
      }

      #external-events {
        position: fixed;
        z-index: 2;
        top: 20px;
        left: 20px;
        width: 250px;
        padding: 0 10px;
        border: 1px solid #ccc;
        background: #eee;
        overflow-y: auto;
        height: calc(100vh - 40px);
      }

      #external-events .fc-event {
        cursor: move;
        margin: 3px 0;
      }

      #calendar-container {
        position: relative;
        z-index: 1;
        margin-left: 300px;
      }

      #calendar {
        max-width: 1100px;
        margin: 20px auto;
      }
      svg {
        width: 25px;
        height: 25px;
      }
      svg:hover {
        fill: red;
        cursor: pointer;
      }
      .v-name-section:hover {
        background-color: rgb(197, 234, 62);
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="external-events">
        <div class="d-grid mt-2 mb-3">
          <button
            class="btn btn-primary"
            type="button"
            @click="showAddVNameModal"
          >
            เพิ่มเวร
          </button>
        </div>
        <form>
          <div
            class="row v-name-section"
            v-for="vname in vnames"
            :key="vname.id"
          >
            <div class="col-auto me-auto">
              <strong>{{ vname.name }}</strong>
            </div>
            <div class="col-auto mb-2">
              <svg
                @click="showEditVNameModal(vname.id)"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="feather feather-edit"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                ></path>
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                ></path>
              </svg>
            </div>
          </div>
        </form>
        <hr />

        <div class="d-grid">
          <div>
            <select
              class="form-select"
              aria-label="Default select example"
              v-model="selectVName"
              @change="fetchMenbers(selectVName)"
            >
              <option v-for="vname in vnames" :key="vname.id" :value="vname.id">
                {{vname.name}}
              </option>
            </select>
          </div>

          <div v-for="member in members" :key="member.id">
            <div
              class="fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event"
              :data-v_names_id="member.v_names_id"
              :data-v_members_id="member.id"
            >
              <div class="fc-event-main">{{member.name}}</div>
            </div>
          </div>
          <div>
            <button
              type="button"
              v-if="selectVName"
              @click="showAddMemberModal"
            >
              add member {{selectVName}}
            </button>
          </div>
        </div>
      </div>

      <div id="calendar-container">
        <div id="calendar"></div>
      </div>

      <!-- Modal for Adding v_names -->
      <div
        class="modal fade"
        id="addVNameModal"
        tabindex="-1"
        aria-labelledby="addVNameModalLabel"
        aria-hidden="true"
        ref="addVNameModal"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addVNameModalLabel">Add v_names</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="row">
                  <div class="mb-3">
                    <label for="vNameInput" class="form-label"
                      >v_names Name:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      v-model="newVName.name"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="vColorInput" class="form-label"
                      >v_names Color:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      v-model="newVName.color"
                    />
                  </div>

                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-danger"
                      data-bs-dismiss="modal"
                      @click="deleteVName(newVName.id)"
                      v-if="newVName.action == 'update'"
                    >
                      Delete
                    </button>
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancel
                    </button>
                    <button
                      v-if="newVName.action == 'update'"
                      @click="editVName"
                      v-if="newVName.id"
                      type="button"
                      class="btn btn-warning"
                    >
                      Update
                    </button>
                    <button
                      v-if="newVName.action == 'insert'"
                      @click="addVName"
                      type="button"
                      class="btn btn-primary"
                    >
                      Save
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal for Adding v_members -->
      <div
        class="modal fade"
        id="addMemberModal"
        tabindex="-1"
        aria-labelledby="addMemberModalLabel"
        aria-hidden="true"
        ref="addMemberModal"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addMemberModalLabel">Add members</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="row">
                  <div>
                    <table class="table">
                      <tr v-for="member,index in members" ::key="member.id">
                        <td>{{member.sort}}</td>
                        <td>{{member.name}}</td>
                        <td>
                          <button
                            type="button"
                            @click="showEditMemberModal(member.id)"
                          >
                            edit
                          </button>
                          <button
                            type="button"
                            @click="deleteMember(member.id)"
                          >
                            del
                          </button>
                        </td>
                      </tr>

                      <tr>
                        <td>
                          <input
                            type="number"
                            name="memberSort"
                            id="memberSort"
                            v-model="newMember.sort"
                          />
                        </td>
                        <td>
                          <input
                            type="text"
                            name="member"
                            id="member"
                            v-model="newMember.name"
                            required
                          />
                        </td>
                        <td>
                          <button type="button" @click="addMember">Add</button>
                        </td>
                      </tr>
                    </table>
                  </div>
                  <div>{{newMember}}</div>

                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-danger"
                      data-bs-dismiss="modal"
                      @click="deleteVName(newMember.id)"
                      v-if="newMember.action == 'update'"
                    >
                      Delete
                    </button>
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancel
                    </button>
                    <button
                      v-if="newMember.action == 'update'"
                      @click="editMember"
                      type="button"
                      class="btn btn-warning"
                    >
                      Update
                    </button>
                    <button
                      v-if="newMember.action == 'insert'"
                      @click="addMember"
                      type="button"
                      class="btn btn-primary"
                    >
                      Save
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal for Adding v_members_sub -->
      <div
        class="modal fade"
        id="editMemberModal"
        tabindex="-2"
        aria-labelledby="editMemberModalLabel"
        aria-hidden="true"
        ref="editMemberModal"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editMemberModalLabel">Add members</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="row">
                  <div>
                    <form @submit.prevent="editMember">
                      <input type="text" v-model="newMember.sort" />
                      <input type="text" v-model="newMember.name" />
                    </form>
                  </div>
                  <div>{{newMember}}</div>

                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-danger"
                      data-bs-dismiss="modal"
                      @click="deleteMember(newMember.id)"
                      v-if="newMember.action == 'update'"
                    >
                      Delete
                    </button>
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancel
                    </button>
                    <button
                      v-if="newMember.action == 'update'"
                      @click="editMember"
                      type="button"
                      class="btn btn-warning"
                    >
                      Update
                    </button>
                    <button
                      v-if="newMember.action == 'insert'"
                      @click="addMember"
                      type="button"
                      class="btn btn-primary"
                    >
                      Save
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal for Adding events -->
      <div
        class="modal fade"
        id="addEventModal"
        tabindex="-1"
        aria-labelledby="addEventModalLabel"
        aria-hidden="true"
        ref="addEventModal"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addEventModalLabel">Add Event</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form @submit.prevent="addEvent">
                <div class="mb-3"></div>
                <div class="mb-3"></div>
                <div>{{newEvent}}</div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-danger"
                    data-bs-dismiss="modal"
                    @click="deleteEvent(newEvent.id)"
                    v-if="newEvent.id"
                  >
                    Delete
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Cancel
                  </button>
                  <button type="submit" class="btn btn-primary">Save</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var Draggable = FullCalendar.Draggable;
        var containerEl = document.getElementById("external-events");
        new Draggable(containerEl, {
          itemSelector: ".fc-event",
          eventData: function (eventEl) {
            return {
              title: eventEl.innerText,
            };
          },
        });
      });
    </script>

    <!-- Custom JavaScript with Vue 3 and FullCalendar -->
    <script>
      const { createApp, ref, onMounted } = Vue;

      createApp({
        setup() {
          const vnames = ref([]);
          const newVName = ref({
            name: "",
            color: "",
          });
          const btnSaveVName = ref(null);

          const members = ref([]);
          const newMember = ref({
            vNameId: "",
            name: "",
            sort: "",
            action: "insert",
          });

          const newEvent = ref({
            vNameId: "",
            vMemberId: "",
            title: "",
            start_date: "",
          });

          const selectVName = ref("");
          const calendar = ref(null);

          onMounted(() => {
            fetchVNames();
            initializeCalendar();
          });

          const initializeCalendar = () => {
            calendar.value = new FullCalendar.Calendar(
              document.getElementById("calendar"),
              {
                headerToolbar: {
                  left: "prev,next today",
                  center: "title",
                  right: "dayGridMonth",
                },
                height: "auto",
                editable: true,
                droppable: true, // this allows things to be dropped onto the calendar
                dateClick(info) {
                  // Handle date click for adding new events
                  showAddEventModal(info.dateStr);
                },
                drop(info) {
                  // Handle event drop from external events to calendar
                  handleEventDrop(info);
                },
                eventClick(info) {
                  // Handle event click for editing events
                  showEditEventModal(info.event);
                },
                events: fetchEvents, // Load events from the API using Axios
                editable: true,

                eventDrop: function (info) {
                  handleEventMoveDrop(info);
                },
              }
            );

            calendar.value.render();
          };

          const fetchMenbers = () => {
            axios
              .get(
                `./backend/api.php?endpoint=v_members&v_names_id=${selectVName.value}`
              )
              .then((response) => {
                members.value = response.data;
              });
          };

          const showAddMemberModal = () => {
            newMember.value = {
              v_names_id: selectVName.value,
              name: "",
              sort: "",
              action: "insert",
            };
            const addMemberModal = new bootstrap.Modal(
              document.getElementById("addMemberModal")
            );
            addMemberModal.show();
          };

          const addMember = async () => {
            await axios
              .post("./backend/api.php?endpoint=v_members", newMember.value)
              .then((response) => {
                console.log(response);
                newMember.value = {
                  v_names_id: selectVName.value,
                  name: "",
                  sort: "",
                  action: "insert",
                };
                // bootstrap.Modal.getInstance(
                //   document.getElementById("addMemberModal")
                // ).hide();
                fetchMenbers();
              })
              .catch((error) => {
                console.error("Error adding addMember:", error);
              });
          };

          const showEditMemberModal = async (id) => {
            try {
              const response = await axios.get(
                `./backend/api.php?endpoint=v_members&id=${id}`
              );
              console.log(response);

              // Populate newMember with data from the response
              newMember.value = {
                id: response.data.id,
                v_names_id: response.data.v_names_id,
                name: response.data.name,
                sort: response.data.sort,
                action: "update",
              };

              // Show the modal
              const editMemberModal = new bootstrap.Modal(
                document.getElementById("editMemberModal")
              );
              editMemberModal.show();
            } catch (error) {
              console.error("Error fetching member data:", error);
            }
          };

          const editMember = async () => {
            await axios
              .put("./backend/api.php?endpoint=v_members", newMember.value)
              .then((response) => {
                console.log(response);
                newMember.value = {
                  v_names_id: selectVName.value,
                  name: "",
                  sort: "",
                  action: "insert",
                };
                bootstrap.Modal.getInstance(
                  document.getElementById("editMemberModal")
                ).hide();
                fetchMenbers();
              })
              .catch((error) => {
                console.error("Error adding addMember:", error);
              });
          };

          const deleteMember = async (id) => {
            await axios
              .delete("./backend/api.php?endpoint=v_members", { data: { id } })
              .then((response) => {
                // events = events.filter((event) => event.id !== id);
                fetchMenbers();
              })
              .catch((error) => {
                console.error("Error Delete v_members:", error);
              });
          };

          const fetchVNames = () => {
            axios.get("./backend/api.php?endpoint=v_names").then((response) => {
              vnames.value = response.data;
            });
          };

          const showAddVNameModal = () => {
            newVName.value = {
              name: "",
              color: "",
              action: "insert",
            };
            const addVNameModal = new bootstrap.Modal(
              document.getElementById("addVNameModal")
            );
            addVNameModal.show();
          };

          const addVName = async () => {
            await axios
              .post("./backend/api.php?endpoint=v_names", newVName.value)
              .then((response) => {
                console.log(response);
                newVName.value = {
                  name: "",
                  color: "",
                };
                bootstrap.Modal.getInstance(
                  document.getElementById("addVNameModal")
                ).hide();
                fetchVNames();
              })
              .catch((error) => {
                console.error("Error adding v_name:", error);
              });
          };

          const showEditVNameModal = async (id) => {
            response = await axios.get(
              `./backend/api.php?endpoint=v_names&id=${id}`
            );
            console.log(response);
            newVName.value = {
              id: response.data.id,
              name: response.data.name,
              color: response.data.color,
              action: "update",
            };
            const addVNameModal = new bootstrap.Modal(
              document.getElementById("addVNameModal")
            );
            addVNameModal.show();
          };

          const editVName = async () => {
            response = await axios
              .put("./backend/api.php?endpoint=v_names", newVName.value)
              .then((response) => {
                console.log(response);
                newVName.value = {
                  name: "",
                  color: "",
                };
                bootstrap.Modal.getInstance(
                  document.getElementById("addVNameModal")
                ).hide();
                fetchVNames();
              })
              .catch((error) => {
                console.error("Error adding v_name:", error);
              });
          };

          const deleteVName = async (id) => {
            await axios
              .delete("./backend/api.php?endpoint=v_names", { data: { id } })
              .then((response) => {
                // events = events.filter((event) => event.id !== id);
              })
              .catch((error) => {
                console.error("Error Delete v_names:", error);
              });
            fetchVNames();
          };

          const fetchEvents = async (
            info,
            successCallback,
            failureCallback
          ) => {
            await axios
              .get("./backend/api.php?endpoint=events")
              .then((response) => {
                const events = response.data.map((event) => ({
                  id: event.id,
                  title: event.title,
                  start: event.start_date,
                  allDay: true,
                }));
                successCallback(events);
              })
              .catch((error) => {
                console.error("Error fetching events:", error);
                failureCallback(error);
              });
          };

          const addEvent = async () => {
            await axios
              .post("./backend/api.php?endpoint=events", newEvent.value)
              .then((response) => {
                bootstrap.Modal.getInstance(
                  document.getElementById("addEventModal")
                ).hide();
                initializeCalendar();
              })
              .catch((error) => {
                console.error("Error adding v_name:", error);
              });
          };

          const deleteEvent = async (id) => {
            await axios
              .delete("./backend/api.php?endpoint=events", { data: { id } })
              .then((response) => {})
              .catch((error) => {
                console.error("Error Delete v_names:", error);
              });
            initializeCalendar();
          };

          const showAddEventModal = (dateStr) => {
            // Implementation for showing the modal to add a new event
            newEvent.value = {
              vNameId: "",
              vMemberId: "",
              title: "",
              start_date: dateStr,
            };
            const addEventModal = new bootstrap.Modal(
              document.getElementById("addEventModal")
            );
            addEventModal.show();
            console.log("Show add event modal for date:", dateStr);
          };

          const showEditEventModal = async (event) => {
            try {
              // ทำการดึงข้อมูล event จาก backend
              const response = await axios.get(
                `./backend/api.php?endpoint=events&id=${event.id}`
              );
              fetchVNames();
              fetchMenbers(response.data.v_name_id);
              // อัพเดตข้อมูลใน newEvent.value ด้วยข้อมูลจาก response
              newEvent.value = {
                id: response.data.id, // ใส่ id ของ event ถ้าจำเป็นในการบันทึกการแก้ไข
                vNameId: response.data.v_name_id,
                vMemberId: response.data.v_member_id,
                title: response.data.title,
                start_date: response.data.start_date,
              };

              // เปิดโมดัลสำหรับการแก้ไข event
              const addEventModal = new bootstrap.Modal(
                document.getElementById("addEventModal")
              );
              addEventModal.show();

              // console.log("Show edit event modal for event:", response.data[0]);
            } catch (error) {
              console.error("Error fetching event data:", error);
            }
          };

          const handleEventDrop = async (info) => {
            // Handle event drop from external events to calendar
            await axios
              .post("./backend/api.php?endpoint=events", {
                v_names_id: info.draggedEl.dataset.v_names_id,
                v_members_id: info.draggedEl.dataset.v_members_id,
                title: info.draggedEl.outerText,
                start_date: info.dateStr,
              })
              .then((response) => {
                initializeCalendar();
              })
              .catch((error) => {
                console.error("Error adding events:", error);
              });
          };
          const handleEventMoveDrop = async (info) => {
            // Handle event drop from external events to calendar
            await axios
              .put("./backend/api.php?endpoint=events&action=move", {
                id: info.event.id,
                start_date: info.event.startStr,
              })
              .then((response) => {
                initializeCalendar();
              })
              .catch((error) => {
                console.error("Error adding events:", error);
              });
          };

          return {
            vnames,
            newVName,
            newEvent,
            members,
            newMember,
            selectVName,
            btnSaveVName,
            fetchVNames,
            showAddVNameModal,
            showEditVNameModal,
            addVName,
            editVName,
            deleteVName,
            showAddEventModal,
            addEvent,
            deleteEvent,

            fetchMenbers,
            showAddMemberModal,
            showEditMemberModal,
            addMember,
            editMember,
            deleteMember,
            initializeCalendar,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
